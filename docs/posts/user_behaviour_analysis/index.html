<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Prateek">
<meta name="dcterms.date" content="2024-12-18">

<title>Blog - User behaviour analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Prateek</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/prteek"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">User behaviour analysis</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">markov chain</div>
                <div class="quarto-category">timeseries</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Prateek </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 18, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a>
  <ul class="collapse">
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#future-new-user-count-model" id="toc-future-new-user-count-model" class="nav-link" data-scroll-target="#future-new-user-count-model">Future new user count model</a></li>
  <li><a href="#assigning-states" id="toc-assigning-states" class="nav-link" data-scroll-target="#assigning-states">Assigning states</a></li>
  <li><a href="#calculating-transition-matrix" id="toc-calculating-transition-matrix" class="nav-link" data-scroll-target="#calculating-transition-matrix">Calculating transition matrix</a></li>
  <li><a href="#initial-state-counts" id="toc-initial-state-counts" class="nav-link" data-scroll-target="#initial-state-counts">Initial state counts</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p><em>Duolingo</em> have been making waves with their customer success stories and strong (and growing) user base. They seem to be taking their metrics seriously and have done a great job explaining their approach to understanding user behaviour in this <a href="https://blog.duolingo.com/growth-model-duolingo/">post</a>. <br> In the current blog, I wanted to apply their methodology and use it for predicting future customer behaviours. <br></p>
<p>The problem statement driving this analysis is simple. Duolingo want to predict their future <em>daily active users (DAU)</em> with some control handles that they can manipulate to improve those numbers e.g.&nbsp;send reminders to <em>at risk weekly active users</em> or reward campaigns to <em>at risk monthly active users</em>. <br> They may be able to run (or have already run) experiments identifying the effects of these campaigns and reminder in terms of % of people that respond to the treatment and revert back to being daily active. <br> This allows them to efficiently allocate resources and maintain a healthy user base that eventually materialises into paying customers. <br></p>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">Methodology</h2>
<p>First we shall model the process as a Markov chain to see how well the approach predicts future user counts. <br> Subsequently, to validate MC approach and rethink the problem setup in want of simplification, we shall look to model the time-series as a regression problem. We shall do this respecting the mechanics of transition and see how far this can get us in terms of analysing and controlling the process.</p>
<p>At day d (d = 1, 2, … ) of a user’s lifetime, the user can be in one of the following 7 (mutually-exclusive) states: <br></p>
<ul>
<li>new : learners who are experiencing Duolingo for the first time ever</li>
<li>current : learners active today, who were also active in the past week</li>
<li>reactivated : learners active today, who were also active in the past month (but not the past week)</li>
<li>resurrected : learners active today, who were last active &gt;30 days ago</li>
<li>at_risk_wau (at risk weekly active users) : learners who have been active within the past week, but not today</li>
<li>at_risk_mau (at risk monthly active users) : learners who were active within the past month, but not the past week</li>
<li>dormant : learners who have been inactive for at least 30 days</li>
</ul>
<p>A brief overview of how these states are related is below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="states.png" class="img-fluid figure-img"></p>
<figcaption>User states and transitions</figcaption>
</figure>
</div>
<p>The transition acronyms are defined below:</p>
<ul>
<li>NURR : New User Retention Rate (The proportion of day 1 learners who return on day 2)</li>
<li>CURR : Current User Retention Rate (This is not a 100%. Not all of current users stay active every day since people forget to complete a lesson, or have technical difficulties, or just want to take a break)</li>
<li>RURR : Reactivated User Retention rate (The proportion of <em>at_risk_mau</em> who became active today)</li>
<li>SURR : Resurrected User Retention rate (The proportion of <em>dormant</em> users who became active today)</li>
<li>iWAURR : The proportion of <em>at_risk_wau</em> users who became active today</li>
</ul>
<p>As is evident, these quantities (along with others) are what will become the elements of Transition matrix (M), that we discuss next.</p>
<p>In keeping with the definition chart above, the next step is to consider user behaviour as a <a href="https://en.wikipedia.org/wiki/Markov_chain">Markov chain</a>. <br> Let M be a transition matrix associated with this Markov process: m(i, j) = P(s_j | s_i) are the probabilities that a user moves to state s_j right after being at state s_i. The matrix M is learned from the historical data.</p>
<p>Assuming that user behavior is stationary (independent of time), the matrix M fully describes the states of all users in the future.</p>
<p>Suppose that the vector u_0 of length 7 contains the counts of users in certain states on a given day (say day 0). According to the Markov model, on the next day (day 1), we expect to have the following number of users (u_1) in respective states:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="count_estimation.png" class="img-fluid figure-img"></p>
<figcaption>State transition counts estimation</figcaption>
</figure>
</div>
<p>Applying this multiplication recursively, we can derive the number of users in any states on any arbitrary day t &gt; 0 in the future (call this vector u_t).</p>
<p>Now, having u_t calculated, we can determine DAU, WAU and MAU values on day t:</p>
<ul>
<li>DAU_t = #New_t + #Current_t + #Reactivated_t + #Resurrected_t</li>
<li>WAU_t = DAU_t + #AtRiskWau_t</li>
<li>MAU_t = DAU_t + #AtRiskWau_t + #AtRiskMau_t</li>
</ul>
<p>Finally, here’s the algorithm outline:</p>
<ol type="1">
<li>For each prediction day t = 1, …, T, calculate the expected number of new users #New_1, …, #New_T.</li>
<li>For each lifetime day of each user, assign one of the 7 states.</li>
<li>Calculate the transition matrix M from the historical data.</li>
<li>Calculate initial state counts u_0 corresponding to day t=0.</li>
<li>Recursively calculate u_{t+1} = M^t * u_0.</li>
<li>Calculate DAU, WAU, and MAU for each prediction day t = 1, …, T.</li>
</ol>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>We use a simulated dataset based on historical data of a SaaS app. <br> The data is available <a href="https://raw.githubusercontent.com/prteek/regression_room/refs/heads/main/posts/user_behaviour_analysis/dau_data.csv">here</a> and contains three columns: <strong>user_id, date, and registration_date</strong>.</p>
<p>Each record indicates a day when a user was active. <br></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dau_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"dau_data.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(dau_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">date</th>
<th style="text-align: left;">registration_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">d8c465ab-e9fd-5edd-9e4e-c77094700cb5</td>
<td style="text-align: left;">2020-10-01</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="even">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-01</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bfeac474-5b66-566f-8654-262bb79c873e</td>
<td style="text-align: left;">2020-10-01</td>
<td style="text-align: left;">2020-05-31</td>
</tr>
<tr class="even">
<td style="text-align: left;">d32fcac5-122c-5463-8aea-01b39b9ad0bb</td>
<td style="text-align: left;">2020-10-01</td>
<td style="text-align: left;">2020-09-30</td>
</tr>
<tr class="odd">
<td style="text-align: left;">c1ece677-e643-5bb3-8701-f1c59a0bf4cd</td>
<td style="text-align: left;">2020-10-01</td>
<td style="text-align: left;">2020-09-05</td>
</tr>
<tr class="even">
<td style="text-align: left;">ba6750c9-9b60-58dc-8d40-504e7375249e</td>
<td style="text-align: left;">2020-10-01</td>
<td style="text-align: left;">2020-09-29</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Total users: 51480</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Date range: 2020-10-01 to 2023-10-31</code></pre>
</div>
</div>
<p>This is how DAU timeseries looks</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="future-new-user-count-model" class="level3">
<h3 class="anchored" data-anchor-id="future-new-user-count-model">Future new user count model</h3>
<p>To even begin thinking about transitions on a future date, we first need to acknowledge the fact that new user counts will be a significant missing piece of information in the analysis. <br> To get around this limitation, we shall first build a new user count prediction model that need not be very accurate (since in a realistic setting new user counts can also be a parameter that can be changed).</p>
<p>The information on new users on any given date is inherent in <em>registration_date</em> in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>new_users <span class="ot">&lt;-</span> dau_data <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">filter</span>(date<span class="sc">==</span>registration_date) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarise</span>(<span class="at">new_user_count=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">week_of_year =</span> <span class="fu">isoweek</span>(date),  <span class="co"># ISO 8601 week (Monday starts the week)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">month =</span> <span class="fu">as.factor</span>(<span class="fu">month</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">TRUE</span>)),  <span class="co"># Month as abbreviated name</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">day_of_week =</span> <span class="fu">wday</span>(date)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>lmod <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(new_user_count <span class="sc">~</span> year <span class="sc">*</span> <span class="fu">bs</span>(week_of_year,<span class="dv">4</span>) <span class="sc">+</span> month <span class="sc">+</span> day_of_week , <span class="at">data=</span>new_users)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(lmod)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After some experimentation, the model setup to predict future counts of new users is as above. <br> The counts are assumed Poisson but with a higher variance than normal due to spikes in the data and hence a <em>negative binomial</em> model has been used. <br> It was imperative that we used a <em>robust</em> version of GLM to be able to get relatively constant variance of errors, that were being caused due to outliers in user count towards beginning of every year. <br> The model appears to be doing a satisfactory job of predicting counts of new users and we consider this acceptable for further analysis.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="assigning-states" class="level3">
<h3 class="anchored" data-anchor-id="assigning-states">Assigning states</h3>
<p>There needs to be an assignment of one of the 7 states (mentioned earlier) against each date for a user. This will help identify transitions made between states and populate the Transition matrix. However, the data only consists of records of <em>active days</em>, we need to explicitly extend them and include the days when a user was not active. In other words, instead of this table of records:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>user_id</th>
<th>date</th>
<th>registration_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1234567</td>
<td>2023-01-01</td>
<td>2023-01-01</td>
</tr>
<tr class="even">
<td>1234567</td>
<td>2023-01-03</td>
<td>2023-01-01</td>
</tr>
</tbody>
</table>
<p>we’d like to get a table like this:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>user_id</th>
<th>date</th>
<th>is_active</th>
<th>registration_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1234567</td>
<td>2023-01-01</td>
<td>TRUE</td>
<td>2023-01-01</td>
</tr>
<tr class="even">
<td>1234567</td>
<td>2023-01-02</td>
<td>FALSE</td>
<td>2023-01-01</td>
</tr>
<tr class="odd">
<td>1234567</td>
<td>2023-01-03</td>
<td>TRUE</td>
<td>2023-01-01</td>
</tr>
<tr class="even">
<td>1234567</td>
<td>2023-01-04</td>
<td>FALSE</td>
<td>2023-01-01</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td>1234567</td>
<td>2023-10-31</td>
<td>FALSE</td>
<td>2023-01-01</td>
</tr>
</tbody>
</table>
<p>And using this table, subsequently estimate <em>states</em> using simple rules (mentioned in definitions above) for each user_id, corresponding to each day in the data.</p>
<p>The volume of data at our disposal makes this a challenging task to run conveniently on a small machine, so the state determination is performed offline and the code to do it can be found <a href="https://github.com/prteek/regression_room/blob/main/posts/user_behaviour_analysis/prepare_states.r">here</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'states.csv'</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(states <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">'269b7f13-a509-5174-85cb'</span>, user_id)) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">between</span>(date, <span class="fu">as.Date</span>(<span class="st">'2020-10-18'</span>), <span class="fu">as.Date</span>(<span class="st">'2020-10-30'</span>)))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 42%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 13%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">date</th>
<th style="text-align: left;">is_active</th>
<th style="text-align: left;">state</th>
<th style="text-align: left;">registration_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-18</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">current</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="even">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-19</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">current</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-20</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">current</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="even">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-21</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">at_risk_wau</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-22</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">at_risk_wau</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="even">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-23</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">at_risk_wau</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-24</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">at_risk_wau</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="even">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-25</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">at_risk_wau</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-26</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">at_risk_wau</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="even">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-27</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">at_risk_mau</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-28</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">reactivated</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="even">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-29</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">current</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">269b7f13-a509-5174-85cb-95a8f7b932e8</td>
<td style="text-align: left;">2020-10-30</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">current</td>
<td style="text-align: left;">2020-08-25</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="calculating-transition-matrix" class="level3">
<h3 class="anchored" data-anchor-id="calculating-transition-matrix">Calculating transition matrix</h3>
<p>We need a flexible approach to calculate transition matrix over any arbitrary period of time. This is because it is likely that transition matrix changes over time as user preferences and product itself evolves.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>get_transition_matrix <span class="ot">&lt;-</span> <span class="cf">function</span> (states_slice) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressMessages</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> states_slice <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(user_id) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">state_to =</span> <span class="fu">lead</span>(state)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                , <span class="at">state_from =</span> state</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(state_to)) <span class="sc">%&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(user_id, state_from, state_to) <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">transition_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(state_from, state_to) <span class="sc">%&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">transition_count =</span> <span class="fu">sum</span>(transition_count)) <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> state_to, <span class="at">values_from =</span> transition_count, <span class="at">values_fill =</span> <span class="fu">list</span>(<span class="at">transition_count =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">row_sum =</span> <span class="fu">rowSums</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(., <span class="sc">-</span>state_from))) <span class="sc">%&gt;%</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="sc">-</span>state_from, <span class="sc">~</span> . <span class="sc">/</span> row_sum)) <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>row_sum)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> (M)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>M <span class="ot">=</span> <span class="fu">get_transition_matrix</span>(states <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">between</span>(date, <span class="fu">as.Date</span>(<span class="st">'2022-11-01'</span>), <span class="fu">as.Date</span>(<span class="st">'2023-11-01'</span>))))</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(M)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">state_from</th>
<th style="text-align: right;">at_risk_mau</th>
<th style="text-align: right;">dormant</th>
<th style="text-align: right;">reactivated</th>
<th style="text-align: right;">resurrected</th>
<th style="text-align: right;">at_risk_wau</th>
<th style="text-align: right;">current</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">at_risk_mau</td>
<td style="text-align: right;">0.9520158</td>
<td style="text-align: right;">0.0384384</td>
<td style="text-align: right;">0.0093866</td>
<td style="text-align: right;">0.0001591</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">at_risk_wau</td>
<td style="text-align: right;">0.1308719</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0044715</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.7663644</td>
<td style="text-align: right;">0.0982922</td>
</tr>
<tr class="odd">
<td style="text-align: left;">current</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.1487694</td>
<td style="text-align: right;">0.8512306</td>
</tr>
<tr class="even">
<td style="text-align: left;">dormant</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.9996200</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0003800</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">new</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.4836773</td>
<td style="text-align: right;">0.5163227</td>
</tr>
<tr class="even">
<td style="text-align: left;">reactivated</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.6353907</td>
<td style="text-align: right;">0.3646093</td>
</tr>
<tr class="odd">
<td style="text-align: left;">resurrected</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.6848495</td>
<td style="text-align: right;">0.3151505</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As a sanity check, we can analyse the matrix itself. <br> It makes sense that <em>current</em> -&gt; <em>current</em> transition value is high. This means that active users tend to continue being active with high probability or otherwise become <em>at_risk_wau</em>. <br> It also seems sensible that there is no state from which one could transition to <em>new</em>. Apparantly quite a high proportion of <em>dormant</em> users stay <em>dormant</em> which could be one of the focuses of resurrection campaigns in such companies.</p>
</section>
<section id="initial-state-counts" class="level3">
<h3 class="anchored" data-anchor-id="initial-state-counts">Initial state counts</h3>
<hr>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>