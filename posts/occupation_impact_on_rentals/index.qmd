---
title: "Impact of occupations on UK rentals"
author: "Prateek"
date: "2025-11-30"
categories: [random effects, hierarchical models, glm, binomial]
image: "rentals_2021.png"
toc: true
bibliography: references.bib
description: "Assessing if (and how) occupations affect local rental market"
execute:
  echo: false

---

```{r}
#| warning: false
readRenviron(file.path(here::here(), '.local_credentials'))

renv::load(here::here())
library(tidyverse)
library(lme4)
library(faraway)
library(DBI)
library(duckdb)
library(tidyverse)
library(RAthena)
library(tidymodels)

data_dir <- file.path(
  here::here(),
  "posts",
  "occupation_impact_on_rentals",
  "data"
)

con <- dbConnect(
  drv = duckdb(),
  dbdir = file.path(data_dir, "lab.duckdb")
)

acon <- dbConnect(
  athena(),
  workgroup = "primary",
  schema_name = "default",
  s3_staging_dir = "s3://aws-athena-query-results-434616802091-eu-west-1",
  profile_name = "personal",
  region = "eu-west-1",
)
athena_sql <- function(query) {
  tibble(dbGetQuery(acon, query))
}

sql <- function(query) {
  tibble(dbGetQuery(con, query))
}

theme_set(theme_minimal())

```


## Data

Cross tabulated MSOA level data on Tenure by Occupation, from ONS 2021 Census can be found from Nomisweb API [@ONS2021RM140] <br/>
The unit of measurement (i.e. a single count) refers to a Household Representative persion (referred to as HRP henceforth), thus associating a unique occupation to a given household.
This data will differ from total count of people in full time occupation from any other dataset (e.g. data on occupation by age, as used in this study), because there may be multiple people in full time occupation in a household.


```{r}
sql(
  "select *
from msoa_tenure_occupation
order by random()
limit 10"
) %>%
  head() %>%
  knitr::kable()

```

## Dataset

### Additional information

Local authority for each MSOA in original dataset is added, to account for rental patterns that may be present at local area levels. Being in the same Local authority may affect neighbouring MSOAs introducing correlations in their data. <br/>


It can be possible that age has a confounding effect on Rentership via Occupation. Majority of Professional and Managers may likely be older than associates and this may mean that they were able to purchase a house earlier in their careers/life and now represent a smaller proportion of rental cohort. <br/>
Adjusting for age gives an apples-to-apples comparison of rentership preference among people pursuing different occupations but are in boradly same phases of their life. <br/>
The adjustment is made by including the proportion of full-time employed HRPs in an MSOA engaged in a particular profession falling in one of the following age bands: <br/>

* aged 15 years and under
* aged 16 to 24 years
* aged 25 to 34 years
* aged 35 to 49 years
* aged 50 to 64 years
* aged 65 years and over

**Note:** <br/>
This adjustment is inexact since the data is available for all people in full time occupation rather than just HRP (which is the unit of measurement in tenure data). This means that likely an HRP would be an older person, the counts in age dataset include other members of the household which are possibly younger, creating a slight disconnect between the 2 datasets. <br/>
It is neverthless instructive to use this information as the downsides due to excluding this information outweigh downsided due to (incorrectly) including it.


Since, the interest lies in proportion of rentership for each occupation, per occupation totals for each MSOA are added to the dataset.


### Filter

Current data only includes measurements from household reference persons (HRP) in full time employment a week before census. <br/>
It would be sensible to drop data if any occupation icluded positive entries in *aged 15 years and under* column.

**Note:** <br/>

* ONS rental tenure data includes a large proportion (~34%) of people not under full time employment[@EHS_21-22_PRS_Ch_1_Annex_Tables] (filtered out in current analysis)
    * part-time work (~11% includes furloughed)
    * retired (~7%)
    * unemployed (~4%)
    * full-time education (~4%)
    * other inactive (~8%)
* The private rented sector houses the highest proportion of non-UK nationals (74% of HRPs in the private rented sector are from the UK, compared to 92% of social renters and 96% of owner occupiers) [@english_housing_survey]


```{r}
sql(
  "select *
    from filtered_dataset
    order by random()
    "
) %>%
  head() %>%
  knitr::kable()

```


### Subsample

Since, the dataset is very well compiled but is large, we can work with reduced dataset and infer large scale effects from it. This reduction will allow speeding up the analysis and experimentation. <br/>
The subsampling process does the following: <br/>

* Randomly sample 10 local authorities from 8 UK wide regions (e.g. West midlands, East of England etc.) excluding London region (since market behaviour may not generalise to other regions and create issues when data is mixed with others, due to very high counts)
* Within each of the sampled local authorities sample 50 MSOAs at random
* Get all the data in the sampled MSOAs

The above procedure is deliberate in that it results in balanced data among Local authorities to avoid issues with inference. <br/>
It goes without saying that this step means that Local Authorities and MSOAs need to be treated as random effects down the line (with appropriate heirarchy). <br/>
The procedure ensures sufficient counts of Local Authorities and MSOAs to be able to reliably capture these random effects.


```{r}
sql("select * from dataset_sample") %>%
  summarise(
    rows = n(),
    distinct_tenure = n_distinct(tenure),
    distinct_occupation = n_distinct(occupation),
    max_counts = max(counts_of_hrp),
    min_counts = min(counts_of_hrp),
    median_counts = median(counts_of_hrp),
    distinct_lad = n_distinct(lad_name),
    distinct_msoa = n_distinct(msoa),
    .groups = 'drop'
  ) %>%
  knitr::kable()

```

## EDA

At the level of MSOA the proportion of rentership can appear quite chaotic and noisy.
```{r}
sql(
  "
select *
  , counts_of_hrp/occupation_total as proportion_renting
  from dataset_filtered
  where msoa in (select distinct(msoa) from dataset_filtered order by random() limit 10)
"
) %>%
  ggplot() +
  geom_line(aes(
    x = occupation,
    y = proportion_renting,
    colour = lad_name,
    group = lad_name
  )) +
  labs(title = 'Sample MSOA data per local authority') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```


The variability in renting due to occupation is visible when looked at in aggregate. This also seems to relate to our intuition where highly skilled and professionals are driving less of the rental market since they may be better placed to afford to buy.

```{r}
sql(
  "
select *
  , counts_of_hrp/occupation_total as proportion_renting
  from dataset_filtered
"
) %>%
  ggplot() +
  geom_boxplot(aes(x = occupation, y = proportion_renting)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylim(0, 0.5) +
  labs(title = 'All MSOA rentership')

```


The observation holds and patterns become more clear when the data is aggregated at Local authority level. This means that a heirarchical consideration of geographies could be a sensible inclusion in the model.

```{r}
sql(
  "
select lad_name
  , occupation
  , sum(counts_of_hrp)/sum(occupation_total) as proportion_renting
  from dataset_filtered
  -- where lad_name in (select distinct(lad_name) from dataset_filtered order by random() limit 10)
  group by lad_name, occupation
"
) %>%
  ggplot() +
  geom_boxplot(aes(
    x = occupation,
    y = proportion_renting,
  )) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylim(0, 0.5) +
  labs(title = 'All Local authority rentership')

```


```{r}
high_counts <- sql(
  "
select msoa
, lad_name
, sum(occupation_total) as msoa_total
from dataset_filtered
group by msoa, lad_name
order by 3 desc
"
)

high_counts %>%
  ggplot() +
  geom_histogram(aes(x = msoa_total))

```

There is a slightly long tail of working population per msoa. <br/>

Looking at the msoa where the greatest proportion of working population is renting, a few key dense local authority areas are highlighted

```{r}
sql(
  "
select lad_name
, msoa
, round(sum(counts_of_hrp)/sum(occupation_total),3) as aggregate_proportion_renting
, sum(occupation_total) as total_working_population
  from dataset_filtered
group by lad_name, msoa
order by 3 desc
"
) %>%
  head(10) %>%
  knitr::kable()

```


## Modelling

### Baseline Model: Fixed effects with data aggregated at LAD level

We refer back to data aggregated at LAD level previously. The variability at each occupation level is quite modest and for the sake of simplification LAD variable is ignored in the baseline. It is expected that this may not be systematically related to other variables like age and occupation. <br/>
Since the data is further aggregated, entire dataset can be used disregarding the need to subsample. Further, *Elementary occupations* are treated as a reference category and effects of other categories are in contrast to this. <br/>
*Occupation* variable appears to be significantly related to probability of renting when controlled for *age*. <br/>

```{r}
lad_dataset <- sql(
  "
select lad_name
  , occupation
  , sum(counts_of_hrp) as renting_total
  , sum(occupation_total) as occupation_total
  , sum(\"aged 15 years and under\" * all_ages_total)/sum(all_ages_total) as \"aged 15 years and under\"
  , sum(\"aged 16 to 24 years\" * all_ages_total)/sum(all_ages_total) as \"aged 16 to 24 years\"
  , sum(\"aged 25 to 34 years\" * all_ages_total)/sum(all_ages_total) as \"aged 25 to 34 years\"
  , sum(\"aged 35 to 49 years\" * all_ages_total)/sum(all_ages_total) as \"aged 35 to 49 years\"
  , sum(\"aged 50 to 64 years\" * all_ages_total)/sum(all_ages_total) as \"aged 50 to 64 years\"
  , sum(\"aged 65 years and over\" * all_ages_total)/sum(all_ages_total) as \"aged 65 years and over\"
  from dataset
  where tenure = 'private rented or lives rent free'
  group by lad_name, occupation
"
) %>%
  mutate(
    occupation = relevel(
      factor(occupation),
      ref = '9. elementary occupations'
    )
  )

glmod_lad <- glm(
  cbind(renting_total, occupation_total) ~
    occupation +
    `aged 25 to 34 years` +
    `aged 35 to 49 years` +
    `aged 50 to 64 years` +
    `aged 65 years and over`,
  lad_dataset,
  family = binomial
)

glmod_lad_no_oc <- glm(
  cbind(renting_total, occupation_total) ~
    `aged 25 to 34 years` +
    `aged 35 to 49 years` +
    `aged 50 to 64 years` +
    `aged 65 years and over`,
  lad_dataset,
  family = binomial
)

print(anova(glmod_lad_no_oc, glmod_lad, test = 'Chi'))

```

The diagnostics do not look too bad and we can retain the model for comparison with more detailed models. <br/>

```{r}
par(mfrow = c(2, 2))
plot(glmod_lad)
par(mfrow = c(1, 1))

```

Additionally, the coefficients make intuitive sense, each occupation category is likely to have less association with renting compared to *elementary occupations*. <br/>
Concretely, people in *professional occupations* are **~50% less likely** (exp(-0.70)-1) to rent compared to people in *elementary occupations*. <br/>

```{r}
occupation_coefs <- tidy(glmod_lad) %>%
  filter(str_detect(term, 'occupation')) %>%
  mutate(term = sub("^occupation", "", term), estimate = exp(estimate)) %>%
  select(term, estimate)

# We do not discuss effect of age since age cannot be varied independently without affecting occupation. Though this does not mean that they have interaction effect on rentership

age_coefs <- tidy(glmod_lad) %>%
  filter(str_detect(term, 'aged')) %>%
  mutate(estimate = exp(estimate * 0.1)) %>%
  select(term, estimate)

ggplot(occupation_coefs) +
  geom_bar(aes(x = term, y = estimate - 1), stat = 'identity') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(
    title = 'Effect of Occupations w.r.t. Elementary Occupations',
    y = 'Reduction in Odds of Renting [%]'
  )

```

### Heirarchical Binomial model at MSOA level with

```{r}

```

### Alternate formulation with Poission rentership and Housholds as exposure

TODO
