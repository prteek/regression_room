---
title: "rentership ~ occupation, analysis"
author: "Prateek"
date: "2025-11-30"
bibliography: references.bib
categories: [random effects, hierarchical models, glm, binomial]
image: "rentals_2021.png"
toc: true
execute:
  echo: false
  warning: false
abstract:
  Using 2021 ONS Census cross-tabulations at the MSOA level, this article
  quantifies how occupation and age shape private rentership in the UK. We
  construct a dataset linking housing tenure to the household reference
  person’s occupation, augment it with local authority identifiers, and apply
  binomial GLMs and hierarchical mixed-effects models with random intercepts for
  local authorities and nested MSOAs. Age-band composition is included to adjust
  for confounding between occupation and life stage. After subsampling to ensure
  balanced coverage across regions (excluding London), results show markedly
  lower odds of renting for higher-skilled groups—Professionals are about 40%
  less likely to rent than Elementary occupations—while rentership peaks among
  25–34 year olds relative to 16–24 year olds. Including geographic random
  effects improves fit and reduces residuals, highlighting spatial heterogeneity
  in rental markets. Limitations include using occupation-by-age data for all
  workers rather than HRPs. Findings support modeling rental demand with both
  occupational structure and local context.

---

```{r}
#| warning: false
readRenviron(file.path(here::here(), '.local_credentials'))

renv::load(here::here())
library(tidyverse)
library(lme4)
library(faraway)
library(DBI)
library(duckdb)
library(RAthena)
library(tidymodels)
library(patchwork)

data_dir <- file.path(
  here::here(),
  "posts",
  "occupation_impact_on_rentals",
  "data"
)

con <- dbConnect(
  drv = duckdb(),
  dbdir = file.path(data_dir, "lab.duckdb")
)

acon <- dbConnect(
  athena(),
  workgroup = "primary",
  schema_name = "default",
  s3_staging_dir = "s3://aws-athena-query-results-434616802091-eu-west-1",
  profile_name = "personal",
  region = "eu-west-1",
)
athena_sql <- function(query) {
  tibble(dbGetQuery(acon, query))
}

sql <- function(query) {
  tibble(dbGetQuery(con, query))
}

theme_set(theme_minimal())

```


## Data

We use 2021 ONS Census data (via the Nomis API) that cross‑tabulates housing tenure and occupation at the MSOA level [@ONS2021RM140]. <br/>
MSOAs (Middle Layer Super Output Areas) are neighborhood‑sized geographies. Counts refer to the household reference person (HRP) the person who represents the household, so each household is linked to a single occupation. <br/>
This differs from datasets that count all workers (for example, occupation‑by‑age used later), because a household can contain more than one person in full‑time work.

```{r}
sql(
  "select *
from msoa_tenure_occupation
order by random()
limit 10"
) %>%
  head() %>%
  knitr::kable()

```

## Dataset

### Additional information

Local authority for each MSOA in original dataset is added, to account for rental patterns that may be present at local area levels. Being in the same Local authority may affect neighbouring MSOAs introducing correlations in their data. <br/>


It can be possible that age has a confounding effect on Rentership via Occupation. Majority of Professional and Managers may likely be older than associates and this may mean that they were able to purchase a house earlier in their careers/life and now represent a smaller proportion of rental cohort. <br/>
Adjusting for age gives an apples-to-apples comparison of rentership preference among people pursuing different occupations but are in boradly same phases of their life. <br/>
The adjustment is made by including the proportion of full-time employed HRPs in an MSOA engaged in a particular profession falling in one of the following age bands: <br/>

* aged 15 years and under
* aged 16 to 24 years
* aged 25 to 34 years
* aged 35 to 49 years
* aged 50 to 64 years
* aged 65 years and over

**Note:** <br/>
This adjustment is inexact since the data is available for all people in full time occupation rather than just HRP (which is the unit of measurement in tenure data). This means that likely an HRP would be an older person, the counts in age dataset include other members of the household which are possibly younger, creating a slight disconnect between the 2 datasets. <br/>
It is neverthless instructive to use this information as the downsides due to excluding this information outweigh downsided due to (incorrectly) including it.

Since, the interest lies in proportion of rentership for each occupation, per occupation totals for each MSOA are added to the dataset.


### Filter

Current data only includes measurements from household reference persons (HRP) in full time employment a week before census. <br/>
It would be sensible to drop data if any occupation icluded positive entries in *aged 15 years and under* column.

**Note:** <br/>

* ONS rental tenure data includes a large proportion (~34%) of people not under full time employment[@EHS_21-22_PRS_Ch_1_Annex_Tables] (filtered out in current analysis)
    * part-time work (~11% includes furloughed)
    * retired (~7%)
    * unemployed (~4%)
    * full-time education (~4%)
    * other inactive (~8%)
* The private rented sector houses the highest proportion of non-UK nationals (74% of HRPs in the private rented sector are from the UK, compared to 92% of social renters and 96% of owner occupiers) [@english_housing_survey]


```{r}
sql(
  "select *
    from filtered_dataset
    order by random()
    "
) %>%
  head() %>%
  knitr::kable()

```


### Subsample

Since, the dataset is very well compiled but is large, we can work with reduced dataset and infer large scale effects from it. This reduction will allow speeding up the analysis and experimentation. <br/>
The subsampling process does the following: <br/>

* Randomly sample 10 local authorities from 8 UK wide regions (e.g. West midlands, East of England etc.) excluding London region (since market behaviour may not generalise to other regions and create issues when data is mixed with others, due to very high counts)
* Within each of the sampled local authorities sample 50 MSOAs at random
* Get all the data in the sampled MSOAs

The above procedure is deliberate in that it results in balanced data among Local authorities to avoid issues with inference. <br/>
It goes without saying that this step means that Local Authorities and MSOAs need to be treated as random effects down the line (with appropriate heirarchy). <br/>
The procedure ensures sufficient counts of Local Authorities and MSOAs to be able to reliably capture these random effects.


```{r}
sql("select * from dataset_sample") %>%
  summarise(
    rows = n(),
    distinct_tenure = n_distinct(tenure),
    distinct_occupation = n_distinct(occupation),
    max_counts = max(counts_of_hrp),
    min_counts = min(counts_of_hrp),
    median_counts = median(counts_of_hrp),
    distinct_lad = n_distinct(lad_name),
    distinct_msoa = n_distinct(msoa),
    .groups = 'drop'
  ) %>%
  knitr::kable()

```

## EDA

At the level of MSOA the proportion of rentership can appear quite chaotic and noisy.
```{r}
sql(
  "
select *
  , counts_of_hrp/occupation_total as proportion_renting
  from dataset_filtered
  where msoa in (select distinct(msoa) from dataset_filtered order by random() limit 10)
"
) %>%
  ggplot() +
  geom_line(aes(
    x = occupation,
    y = proportion_renting,
    colour = lad_name,
    group = lad_name
  )) +
  labs(title = 'Sample MSOA data per local authority') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```

Aggregated data shows clear differences in renting by occupation. Highly skilled and professional workers rent less, likely because they can more easily afford to buy.

```{r}
sql(
  "
select *
  , counts_of_hrp/occupation_total as proportion_renting
  from dataset_filtered
"
) %>%
  ggplot() +
  geom_boxplot(aes(x = occupation, y = proportion_renting)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylim(0, 0.5) +
  labs(title = 'All MSOA rentership')

```


The observation holds and patterns become more clear when the data is aggregated at Local authority level. This means that a heirarchical consideration of geographies could be a sensible inclusion in the model.

```{r}
sql(
  "
select lad_name
  , occupation
  , sum(counts_of_hrp)/sum(occupation_total) as proportion_renting
  from dataset_filtered
  -- where lad_name in (select distinct(lad_name) from dataset_filtered order by random() limit 10)
  group by lad_name, occupation
"
) %>%
  ggplot() +
  geom_boxplot(aes(
    x = occupation,
    y = proportion_renting,
  )) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylim(0, 0.5) +
  labs(title = 'All Local authority rentership')

```


```{r}
high_counts <- sql(
  "
select msoa
, lad_name
, sum(occupation_total) as msoa_total
from dataset_filtered
group by msoa, lad_name
order by 3 desc
"
)

high_counts %>%
  ggplot() +
  geom_histogram(aes(x = msoa_total))

```

There is a slightly long tail of working population per msoa. <br/>

Looking at the msoa where the greatest proportion of working population is renting, a few key dense local authority areas are highlighted

```{r}
sql(
  "
select lad_name
, msoa
, round(sum(counts_of_hrp)/sum(occupation_total),3) as aggregate_proportion_renting
, sum(occupation_total) as total_working_population
  from dataset_filtered
group by lad_name, msoa
order by 3 desc
"
) %>%
  head(10) %>%
  knitr::kable()

```


## Modelling

### Baseline Model: Fixed effects without location information

We refer to data at MSOA level for modelling. For the baseline model, MSOA variable is excluded and *Elementary occupations* are treated as a reference category for *Occupation* variable. *aged 15 years and under* variable is dropped as it is irrelevant for this study. It is immediately obvious that occupation has significant association with proportion of people renting. <br/>

```{r}
dataset <- sql(
  "
select lad_name
  , msoa
  , occupation
  , counts_of_hrp as renting_total
  , occupation_total
  , \"aged 16 to 24 years\" as age_16_24
  , \"aged 25 to 34 years\" as age_25_34
  , \"aged 35 to 49 years\" as age_35_49
  , \"aged 50 to 64 years\" as age_50_64
  , \"aged 65 years and over\" as age_over_65
  from dataset_sample
  where tenure = 'private rented or lives rent free'
  order by msoa, occupation
"
) %>%
  mutate(
    occupation = relevel(
      factor(occupation),
      ref = '9. elementary occupations'
    )
  )

glmod_base <- glm(
  cbind(renting_total, occupation_total - renting_total) ~
    occupation +
    age_25_34 +
    age_35_49 +
    age_50_64 +
    age_over_65,
  data = dataset,
  family = binomial
)

print(anova(glmod_base, test = 'Chisq'))

```

The diagnostics look assuring and at this point, outliers do not appear to be significantly harmful.

```{r}
par(mfrow = c(2, 2))
plot(glmod_base)
par(mfrow = c(1, 1))

```

It can be investigated to see which data points are causing this. <br/>
Manual inspection can be aided by geographic location data [MSOA Map](https://geoportal.statistics.gov.uk/datasets/12baf1e6a44441208ffe5ba5ed063a68_0/explore?location=52.735111%2C-2.489483%2C6.76)

* e02002991 : Is in the middle of Bath town Center and has much higher proportion of Professionals than what model predicts.
* e02006841 : Is a high leverage point. Is in the center of Gateshead, which has slightly higher proportion of Professionals than what model predicts. High leverage comes from 61% Professionals falling in age_25_34 bracket. But the residuals indicate that the influence of this data point is not high
* e02007095: Dinnington, has a very low proportion of rentership (6%), which causes a high value of residuals. This is an affluent, semi-rural village with many of the houses been bought under right to buy legislation [@dinnington].
* e02005775: Harrogate, rentership is severly underpredicted due to 27% Professionals falling in 50-64 age bracket, leading to a high residual.

```{r}
dataset %>%
  augment(glmod_base, .) %>%
  select(
    msoa,
    lad_name,
    occupation,
    starts_with('age'),
    renting_total,
    occupation_total,
    .resid
  ) %>%
  mutate(
    actual_renting_proportion = renting_total / occupation_total,
    predicted_proportion = predict(glmod_base, ., type = 'response')
  ) %>%
  slice(c(8057, 17867, 18452, 15446)) %>%
  select(starts_with('age')) %>%
  knitr::kable()

```

### Using location information in the model

 Each MSOA can have its own level of rentership that needs to be accounted for (and town centers can be very different from suburbs). <br/>
 This is an opportunity for us to introduce location information (LAD and MSOA) in the model. We shall be mindful of the fact that the MSOA and LAD are randomly chosen and that MSOA are nested inside LAD.

```{r}
#| cache: true

glmermod <- glmer(
  cbind(renting_total, occupation_total - renting_total) ~
    occupation +
    age_25_34 +
    age_35_49 +
    age_50_64 +
    age_over_65 +
    (1 | lad_name) +
    (1 | lad_name:msoa),
  data = dataset,
  family = binomial
)

```

Diagnostics have improved and residuals are smaller than before, so the addition of MSOAs in model is worthwhile. This is also confirmed in the ANOVA output.

```{r}
df_plot <- fortify.merMod(glmermod, dataset)

par(mfrow = c(1, 2))
plot(.resid ~ .fitted, df_plot)
abline(h = 0, lty = 2)
lines(lowess(df_plot$.fitted, df_plot$.resid), col = "blue", lwd = 2)
halfnorm(df_plot$.resid)
lines(c(0, 6), c(0, 6), lty = 2)
par(mfrow = c(1, 1))

anova(glmermod, glmod_base, test = "Chisq")

```

Random effects of LAD appear reasonably normally distributed. <br/>
MSOA nested inside LAD are slighly more dispersed and have longer tails.
The worst residual point lies in Catterick Garrison, which is a small town with a large army base and unusually high rentership of *Associate professionals* in that area.

```{r}
par(mfrow = c(1, 2))
qqnorm(
  ranef(glmermod)$lad_name[[1]],
  main = "LAD RE"
)
qqline(ranef(glmermod)$lad_name[[1]], col = "red")

qqnorm(
  ranef(glmermod)$`lad_name:msoa`[[1]],
  main = "LAD:MSOA RE"
)
qqline(ranef(glmermod)$`lad_name:msoa`[[1]], col = "red")

par(mfrow = c(1, 1))

```

Before moving to inference using this model, it is important to check how it fits. ChiSq GoF test suggests p-value `{r} deviance(glmermod) |> pchisq(df.residual(glmermod), lower.tail = F) |> round(2)`, which indicates that there is still quite a lot of variance in data that isn't explained by the current model. <br/>

The dispersion parameter is `{r} (residuals(glmermod, type='pearson')^2/df.residual(glmermod)) |> sum() |> round(2)`. This indicates that dispersion is not too extreme and we chose not to address this.

Looking at the coefficients of Occupation types, since *Elementary Occupations* was reference class, the odds for any Occupation are relative to it. <br/>
In general any Occupation category is less likely to rent compared to *Elementary Occupations*, in particular *Professionals* are nearly 40% less likely (0.6x) to rent.

```{r}
df_coef <- glmermod %>%
  fixef() %>%
  tidy() %>%
  rename(coefficient = x) %>%
  mutate(occupation = str_remove(names, "^occupation\\d+\\.\\s*"))

ggplot(df_coef %>% filter(str_detect(names, 'occupation'))) +
  geom_bar(aes(x = occupation, y = exp(coefficient)), stat = 'identity') +
  labs(
    subtitle = 'Odds of renting compared to Elementary Occupations',
    y = 'Odds of Renting'
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

Age plays a key role in likelihood of renting too. Highest rentership can be observed in 25-34 year olds. This is almost 4x more (300% more) compared to 16-24 year olds. <br/>
This is likely because young adults aged 16-24 rarely act as HRPs for rented homes; instead, they are typically dependent residents in owner-occupied parental households.

```{r}
df_coef <- glmermod %>%
  fixef() %>%
  tidy() %>%
  rename(coefficient = x, age_band = names)

ggplot(df_coef %>% filter(str_detect(age_band, 'age_'))) +
  geom_bar(aes(x = age_band, y = exp(coefficient)), stat = 'identity') +
  labs(
    subtitle = 'Odds of renting compared to 16-24 year olds',
    y = 'Odds of Renting'
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```
