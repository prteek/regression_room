---
title: "Teen gambling analysis"
author: "Prateek"
date: "2025-10-16"
categories: [regression, ANOVA]
image: "gambling.jpeg"
toc: true
description: Analysis of factors affecting teen gambling using regression and ANOVA
---

## Introduction


```{r}
#| warning: false
#| echo: false
library(this.path)
setwd(here())
renv::load()

library(knitr)
library(tidyverse)
library(DBI)
library(RAthena)
library(patchwork)
library(glue)
library(tidymodels)
library(mgcv)
library(faraway)
tidymodels_prefer()
theme_set(theme_minimal())
acon <- dbConnect(
  athena(),
  workgroup = "primary",
  schema_name = "default",
  s3_staging_dir = "s3://aws-athena-query-results-434616802091-eu-west-1",
  profile_name = "personal",
  region = "eu-west-1",
)
athena_sql <- function(query) {
  tibble(dbGetQuery(acon, query))
}

options(width = 400)

```

## Objective
The objective of this analysis is to understand the factors that influence teenage gambling expenditure. We will explore the relationships between gambling expenditure and various predictors.

## Data

The analysis is based on data from Ide-Smith and Lea (1988) published in the Journal of Gambling Behavior. It comes from a survey that was conducted to study teenage gambling in Britain. <br/>

The key variables are:

- sex
- status : Socioeconomic status score based on parents' occupation
- income : Weekly income in pounds
- verbal : verbal score in words out of 12 correctly defined
- gamble : expenditure on gambling in pounds per year

```{r}
#| warning: false
#| cache: true
#| echo: false

teengamb <- faraway::teengamb %>%
  mutate(sex = if_else(sex == 0, 'male', 'female'))

teengamb %>% head() %>% kable()

```

A cursory look at the data suggests that females likely spend less on gambling compared to males. Additionally that most females do not spend more than approx. 20£ per year on gambling.

```{r}
#| echo: false

teengamb %>%
  ggplot(aes(gamble)) +
  geom_density(aes(colour = sex)) +
  labs(
    x = "Expenditure on gambling (pounds per year)",
    y = "Density"
  )

```

There also seems positive association between income and amount spent on gambling (at least for males). This is not very surprising as one would expect that people with higher income would be able to spend more on gambling. <br/>
 From what this plot indicates, it may be worth evaluating if there is a differential effect of income based on sex.

```{r}
#| echo: false

p1 <- teengamb %>%
  ggplot(aes(income, gamble)) +
  geom_point(aes(colour = sex)) +
  labs(
    x = "Income (pounds per week)",
    y = "Expenditure on gambling (pounds per year)"
  )

p2 <- teengamb %>%
  ggplot(aes(sex, gamble)) +
  geom_boxplot() +
  labs(
    x = "Sex",
    y = "Expenditure on gambling (pounds per year)"
  )

p1 + p2

```

## Analysis

Our variable of interest gamble is  strictly positive and continuous with a long tail. We consider taking log of gamble value. This alters the interpretation of model mechanics but it remains sensible, e.g. males spend x% more than females or 1£ increase in income leads to y% increase in expenditure in gambling. <br/>
Side note: This is different from using GLM with Gaussian family and log link. Because in original scale, variance is non constant and multiplicative effects are expected on original scale of response (as opposed to expected value of response). <br/>

To be able to take logarithms of cases where 0£ are spent on gambling, 1£ is added to gambling spent for all cases. This value is chosen to ensure 0 for cases where 0£ are spent and values close to 0 for small spends, additionally this does not introduce un necessary -ve outlier values resulting in better fit. <br/>

Individual *24* seems to have spent 156£ on gambling and likely seems an outlier. This seems to be outside the usual range of expenditure and will not inform the study in a general sense. Hence, we remove this point from the analysis.

### Effect of Gender

It seems plausible that males are spending more on gambling compared to females. This is also indicated by the boxplot below. We will evaluate this hypothesis using a simple linear model with log(gamble + 1) as response and sex as predictor. The procedure is equivalent to a t-test with constant variance assumption.

```{r}
#| echo: false
teengamb <- teengamb %>%
  as_tibble() %>%
  filter(gamble < 150) %>%
  mutate(
    log_gamble = log(gamble + 1),
    sex = factor(sex)
  )

ggplot(teengamb, aes(sex, log_gamble)) +
  geom_boxplot() +
  labs(
    x = "Sex",
    y = "Log(Expenditure on gambling + 1)"
  )

gender_model <- anova(lm(log_gamble ~ sex, data = teengamb))
print(gender_model)

```

Gender seems to be a significant predictor of gambling expenditure (p-value < 0.001).

```{r}

```

### Effect of Sex and Income

```{r}
#| echo: false

income_sex_no_interaction <- lm(
  log_gamble ~ sex + income,
  data = teengamb
)

income_sex_no_interaction %>% summary()

par(mfrow = c(2, 2))
plot(income_sex_no_interaction)
par(mfrow = c(1, 1))

```

We find that there is no obvious problem with the errors. Additionally, the fit is decent and the coefficients for both Sex (Male) and Income are significant. The intercept is non-significant indicating that for reference class (female), gambling expenditure is likely 0£ if they have close to 0 income and it makes intuitive sense (although for adults and addicts this may not necessarily be true). <br/>

Jensen's inequality dictates that simply taking exponents of predictions will under-predict the expected value of response variable `f(E(X)) <= E(f(X))` , a custom predict method is defined which also corrects for the 1£ offset used in model.

```{r}
#| echo: false

# Custom predict method
predict_response <- function(object, newdata, ...) {
  # Get log-scale prediction
  log_pred <- predict(object, newdata = newdata, ...)
  # Get model residual variance
  sigma2 <- summary(object)$sigma^2
  # Bias-corrected prediction
  exp(log_pred + sigma2 / 2) - 1
}


teengamb <- teengamb %>%
  mutate(
    .pred = predict_response(income_sex_no_interaction, .) # subtracting 1 to get prediction on original scale of gamble
  )

teengamb %>%
  ggplot(aes(gamble, .pred)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(
    x = "Actual expenditure on gambling (pounds per year)",
    y = "Predicted expenditure on gambling (pounds per year)"
  )

```
